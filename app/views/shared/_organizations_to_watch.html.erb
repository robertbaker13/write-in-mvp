<% @organizations.each_with_index do |organization, index| %>
<div class='rcorners bg-w row txt-c'>
  <img src=<%= organization.image %> alt="" class='mg p-s col-md-2 img-responsive'>
  <div class='col-md-9 mg p-s debug'>
    <table class='debug w txt-c'>
      <thead>
      <tr class='debug'>
        <th class='txt-c fs-m th-w'><a href="<%= show_path(organization) %>">
          <%= organization.name %></a></td>
        </th>
      </thead>
          <% @candidates_endorsed_by_orgs[index].each do |twitteruser| %>
        <tr>
            <td><%= twitteruser.name %></td>
          <% if @logged_in %>
          <td><%= button_to "Endorse", endorse_path(organization.user_id), :class => "btn-success btn-xs endorse-button",:"aria-hidden"=> "true", :method => :post  %></td>
          <td><%= button_to "Unendorse", endorse_path(organization.user_id), :class => "btn-success btn-xs endorse-button",:"aria-hidden"=> "true", :method => :post, :style => "visibility: hidden"  %></td>
          <% else %>
          <!-- this below button logins in but does not redirect to the right page -->
          <td><%= button_to "Endorse", "/auth/twitter", :class => "btn-success btn-xs endorse-button", :"aria-hidden"=> "true", :method => :post, :headers => { :organization => organization.user }  %></td>
        </tr>
        <% end %>
      <% end %>
    </table>
  </div>
</div>
<% end %>

<script>
$(document).ready(function() {
  watchListener();

});

var watchListener = function () {
  $(".button_to").on("submit", function(e) {
    e.preventDefault();
    var url = this.action;
    var $watchButton = $(this).parent().parent();
    watch(url, $watchButton);
  });

  var watch = function(url, $watchButton){
    console.log(url);
    $.ajax({
      url: url,
      method: "post"
    }).done(function() {
      $watchButton.toggle("slow");
    }).fail(function(){
      console.log("fail");
    });
  }
}
</script>
